<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³Ø§Ù„Ù† Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ù‡ÙˆØ´Ù…Ù†Ø¯</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />
    <style>
        :root { --primary: #2c3e50; --accent: #8e44ad; --bg: #f0f2f5; --success: #27ae60; --danger: #c0392b; --warning: #f1c40f; }
        body { font-family: 'Vazirmatn', sans-serif; background: var(--bg); margin: 0; padding: 15px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; user-select: none; -webkit-tap-highlight-color: transparent; }

        /* Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ */
        .card { background: white; width: 100%; max-width: 650px; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); margin-bottom: 20px; text-align: center; animation: fadeIn 0.5s; position: relative; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
        .btn { border: none; padding: 12px; border-radius: 12px; font-size: 1rem; cursor: pointer; font-family: inherit; width: 100%; font-weight: bold; transition: 0.2s; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:active { transform: scale(0.98); }
        .btn-start { background: var(--accent); color: white; box-shadow: 0 4px 15px rgba(142, 68, 173, 0.3); }
        .btn-next { background: #2980b9; color: white; }
        .btn-finish { background: var(--success); color: white; display: none; }
        .btn-back { background: #ecf0f1; color: #2c3e50; }
        
        /* Ù„ÛŒØ³Øª Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ */
        .exam-item { background: #fff; border: 2px solid #e1bee7; border-radius: 16px; padding: 15px; margin-bottom: 12px; text-align: right; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; position: relative; overflow: hidden; }
        .exam-item:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .exam-item.locked { background: #f8f9fa; border-color: #bdc3c7; opacity: 0.9; }
        .exam-info h4 { margin: 0; color: #4a148c; font-size: 1rem; }
        .exam-info small { color: #7f8c8d; font-size: 0.8rem; display: block; margin-top: 5px; }
        
        /* ØªÛŒÚ© Ø¬Ø¯ÛŒØ¯ */
        .new-badge { position: absolute; top: 0; left: 0; background: var(--danger); color: white; font-size: 0.7rem; padding: 3px 10px; border-radius: 0 0 10px 0; animation: pulse 1.5s infinite; font-weight: bold; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        /* ØµÙØ­Ù‡ Ø±Ø§Ù‡Ù†Ù…Ø§ (Intro) */
        .intro-box { background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); border: 1px solid #ddd; border-radius: 15px; padding: 20px; text-align: center; margin-bottom: 20px; }
        .intro-stat { display: flex; justify-content: space-around; margin: 20px 0; }
        .istat { text-align: center; }
        .istat-val { font-size: 1.5rem; font-weight: bold; color: var(--primary); display: block; }
        .istat-label { font-size: 0.8rem; color: #7f8c8d; }
        
        .reward-list { text-align: right; background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px dashed #27ae60; background-color: #f0fdf4; }
        .reward-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .reward-row:last-child { margin-bottom: 0; border: none; }
        
        /* ØªØ§ÛŒÙ…Ø± */
        .timer-box { font-size: 1.4rem; font-weight: bold; color: var(--danger); background: #fadbd8; padding: 5px 15px; border-radius: 12px; display: inline-block; }

        /* ØªØµØ§ÙˆÛŒØ± Ùˆ Ù„Ø§ÛŒØªâ€ŒØ¨Ø§Ú©Ø³ */
        .q-image { width: 100%; max-width: 100%; height: auto; max-height: 300px; object-fit: contain; border-radius: 12px; border: 1px solid #eee; margin: 15px 0; cursor: zoom-in; background: #fafafa; display: block; margin-left: auto; margin-right: auto; }
        #lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 20000; display: none; justify-content: center; align-items: center; cursor: zoom-out; backdrop-filter: blur(5px); }
        #lightbox img { max-width: 95%; max-height: 95%; border-radius: 10px; box-shadow: 0 0 50px rgba(255,255,255,0.2); animation: zoomIn 0.3s; }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ */
        .option { background: #f8f9fa; border: 2px solid #e9ecef; padding: 15px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; text-align: right; transition: 0.2s; display: flex; flex-direction: column; align-items: flex-start; gap: 8px; width: 100%; box-sizing: border-box; }
        .option:hover { border-color: #b2bec3; }
        .option.selected { background: #e8f6f3; border-color: var(--success); color: var(--success); font-weight: bold; box-shadow: 0 4px 10px rgba(39, 174, 96, 0.2); transform: scale(1.01); }
        .option img { max-width: 100%; height: auto; max-height: 250px; border-radius: 8px; border: 1px solid #ddd; object-fit: contain; align-self: center; margin-top: 5px; display: block; }

        /* Ù†ÙˆØ§Ø± Ù†Ù…Ø±Ù‡ */
        .score-container { margin: 40px 0 20px 0; position: relative; padding-top: 20px; direction: ltr; } 
        .score-bar { height: 25px; width: 100%; border-radius: 15px; background: linear-gradient(90deg, #e74c3c 0%, #e74c3c 39%, #f1c40f 40%, #f1c40f 59%, #2ecc71 60%, #2ecc71 79%, #8e44ad 80%, #8e44ad 100%); position: relative; box-shadow: inset 0 3px 6px rgba(0,0,0,0.2); overflow: visible; }
        
        .score-pointer { 
            position: absolute; 
            top: -15px; 
            width: 0; height: 0; 
            border-left: 10px solid transparent; 
            border-right: 10px solid transparent; 
            border-top: 18px solid #2c3e50; 
            transform: translateX(-50%); 
            transition: left 1.5s cubic-bezier(0.22, 1, 0.36, 1); 
            left: 0%; z-index: 100;
        }
        .score-pointer::after { content: ''; position: absolute; top: -20px; left: -2px; width: 4px; height: 4px; background: white; border-radius: 50%; }

        .score-text { font-size: 2rem; font-weight: bold; margin-top: 25px; color: #2c3e50; text-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .stat-grid { display: flex; justify-content: space-around; margin: 20px 0; background: #f8f9fa; padding: 15px; border-radius: 12px; }
        .stat-item { text-align: center; }
        .stat-num { font-size: 1.3rem; font-weight: bold; display: block; }
        .stat-label { font-size: 0.8rem; color: #7f8c8d; }

        #loading { color: #7f8c8d; font-weight: bold; margin-top: 20px; }
        .full-loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 5000; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 50px; height: 50px; border: 5px solid #eee; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100000; display: none; }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ù…Ø±ÙˆØ± */
        .review-q { border-bottom: 1px solid #eee; padding: 20px 0; }
        .review-q img { max-width: 100% !important; height: auto !important; border-radius: 10px; margin: 10px auto; display: block; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
        .r-opt { padding: 10px; margin: 5px 0; border-radius: 10px; border: 1px solid #eee; background: #fff; }
    </style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>

    <div id="fullLoading" class="full-loading">
        <div class="spinner"></div>
        <h3 style="color:var(--primary); margin-top:20px;">Ø¯Ø±Ø­Ø§Ù„ ØªØµØ­ÛŒØ­ Ø¢Ø²Ù…ÙˆÙ†...</h3>
        <p>Ù„Ø·ÙØ§Ù‹ ØµÙØ­Ù‡ Ø±Ø§ Ù†Ø¨Ù†Ø¯ÛŒØ¯ ğŸ™</p>
    </div>

    <div id="lightbox" onclick="this.style.display='none'">
        <img id="lightboxImg" src="">
    </div>

    <div id="lobby" class="card">
        <div style="font-size: 3.5rem; margin-bottom: 5px;">ğŸ“</div>
        <h2 id="welcomeText" style="margin:0 0 10px 0;">Ø³Ø§Ù„Ù† Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</h2>
        <div id="loading">â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª...</div>
        <div id="resumeAlert" style="display:none; background:#fff3cd; color:#856404; padding:12px; border-radius:12px; margin-bottom:15px; border:1px solid #ffeeba;">âš ï¸ Ø¢Ø²Ù…ÙˆÙ† Ù†Ø§ØªÙ…Ø§Ù… Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯!</div>
        <div id="examList"></div>
        <button class="btn btn-back" onclick="window.location.href='index.html'">ğŸ  Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ú©Ù„Ø§Ø³</button>
    </div>

    <div id="introCard" class="card" style="display:none;">
        <h2 style="color:var(--primary); margin-bottom:10px;" id="introTitle">Ø¹Ù†ÙˆØ§Ù† Ø¢Ø²Ù…ÙˆÙ†</h2>
        
        <div class="intro-box">
            <div class="intro-stat">
                <div class="istat">
                    <span class="istat-val" id="introQCount">0</span>
                    <span class="istat-label">Ø³ÙˆØ§Ù„</span>
                </div>
                <div class="istat">
                    <span class="istat-val" id="introTime">0</span>
                    <span class="istat-label">Ø¯Ù‚ÛŒÙ‚Ù‡ Ø²Ù…Ø§Ù†</span>
                </div>
            </div>
            <p style="font-size:0.9rem; color:#e67e22; font-weight:bold;">âš ï¸ Ù†Ú©ØªÙ‡ Ù…Ù‡Ù…: Ø§Ù…Ú©Ø§Ù† Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø³ÙˆØ§Ù„ Ù‚Ø¨Ù„ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!</p>
        </div>

        <div class="reward-list">
            <h4 style="margin:0 0 10px 0; color:#27ae60;">ğŸ Ø¬ÙˆØ§ÛŒØ² Ø§ÛŒÙ† Ø¢Ø²Ù…ÙˆÙ†:</h4>
            <div class="reward-row">
                <span>ğŸ’ Ø¹Ø§Ù„ÛŒ (Ù‡Ù…Ù‡ Ø¯Ø±Ø³Øª)</span>
                <span style="font-weight:bold; color:#8e44ad;" id="rewEx">300 XP</span>
            </div>
            <div class="reward-row">
                <span>ğŸ¥‡ Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨</span>
                <span style="font-weight:bold; color:#27ae60;" id="rewVg">100 XP</span>
            </div>
            <div class="reward-row">
                <span>ğŸ™‚ Ø®ÙˆØ¨</span>
                <span style="font-weight:bold; color:#2980b9;" id="rewNr">20 XP</span>
            </div>
        </div>

        <button class="btn btn-start" onclick="startExamNow()" style="padding:15px; font-size:1.2rem;">ğŸš€ Ø´Ø±ÙˆØ¹ Ø¢Ø²Ù…ÙˆÙ†</button>
        <button class="btn btn-back" onclick="location.reload()">Ø§Ù†ØµØ±Ø§Ù</button>
    </div>

    <div id="examArea" class="card" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #f1f2f6; padding-bottom: 10px;">
            <span id="qProgress" style="font-weight:bold; color:var(--primary);">Ø³ÙˆØ§Ù„ Û±</span>
            <div id="timer" class="timer-box">00:00</div>
        </div>
        <img id="questionImage" class="q-image" src="" onclick="openLightbox(this.src)" style="display:none;">
        <h3 id="questionText" style="text-align: right; line-height: 1.8; font-size: 1.1rem; color: #34495e;">...</h3>
        <div id="optionsContainer"></div>
        <button id="btnNext" class="btn btn-next" onclick="nextQuestion()">Ø³ÙˆØ§Ù„ Ø¨Ø¹Ø¯ÛŒ â¬…ï¸</button>
        <button id="btnFinish" class="btn btn-finish" onclick="finishExam()">âœ… Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ø¢Ø²Ù…ÙˆÙ†</button>
    </div>

    <div id="reportCard" class="card" style="display: none;">
        <h2 style="color:var(--accent);">ğŸ“Š Ù†ØªÛŒØ¬Ù‡ Ø¹Ù…Ù„Ú©Ø±Ø¯</h2>
        
        <div class="score-container">
            <div class="score-pointer" id="scorePointer"></div>
            <div class="score-bar"></div>
            <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#aaa; margin-top:5px; direction:ltr;">
                <span>0%</span><span>40%</span><span>60%</span><span>80%</span><span>100%</span>
            </div>
        </div>
        
        <div id="qualitativeScore" class="score-text">...</div>

        <div class="stat-grid">
            <div class="stat-item">
                <span id="finalScoreDisplay" class="stat-num" style="color:var(--primary)">0</span>
                <span class="stat-label">Ù†Ù…Ø±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ</span>
            </div>
            <div class="stat-item">
                <span id="xpGainedDisplay" class="stat-num" style="color:var(--success)">0</span>
                <span class="stat-label">Ù¾Ø§Ø¯Ø§Ø´ (XP)</span>
            </div>
        </div>

        <div id="xpMsg" style="background:#e8f6f3; color:#16a085; padding:10px; border-radius:10px; margin-bottom:15px; display:none; margin-top:20px;">
            âœ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± Ø³ÙˆØ§Ø¨Ù‚ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯.
        </div>

        <button id="btnReview" class="btn" style="background:#f39c12; color:white; display:none;" onclick="startReviewMode()">ğŸ” ØªØ­Ù„ÛŒÙ„ Ùˆ Ù…Ø±ÙˆØ± Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§</button>
        <button class="btn btn-back" onclick="window.location.href='index.html'">ğŸ  Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ú©Ù„Ø§Ø³</button>
    </div>

    <div id="reviewArea" class="card" style="display: none; text-align: right;">
        <h3 style="text-align:center; color:#e67e22; border-bottom:2px solid #eee; padding-bottom:10px;">ğŸ§ ØªØ­Ù„ÛŒÙ„ Ø¢Ø²Ù…ÙˆÙ†</h3>
        <p style="color:#777; font-size:0.8rem; text-align:center; margin-bottom:15px;">Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø«Ø¨Øª Ú©Ø±Ø¯ÛŒØ¯ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>
        <div id="reviewContent"></div>
        <button class="btn btn-back" onclick="window.location.href='index.html'">ğŸ  Ù¾Ø§ÛŒØ§Ù† Ù…Ø±ÙˆØ± Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    </div>

    <script src="config.js"></script>
    <script src="rank.js"></script>
    <script>
        const API_URL = APP_CONFIG.API_URL;
        const EXAM_STATE_KEY = "chamran_exam_active_session_v9"; 
        
        let currentUser = null;
        let examsMap = {};
        let currentExamId = null;
        let currentQuestions = [];
        let currentQIndex = 0;
        let userAnswers = {};
        let timerInterval;
        let timeRemaining = 0;

        function init() {
            const savedUser = localStorage.getItem('chamran_db_vfinal_creds');
            if(!savedUser) { window.location.href = 'index.html'; return; }
            try {
                currentUser = JSON.parse(savedUser);
                document.getElementById('welcomeText').innerText = `Ø³Ù„Ø§Ù… ${currentUser.displayName}`;
                
                if(currentUser.jsonData) RankSystem.init(currentUser.jsonData);
                SyncManager.init(currentUser.username, currentUser.password);
                
                const urlParams = new URLSearchParams(window.location.search);
                if(urlParams.get('mode') === 'history_review') {
                    prepareReviewMode(urlParams.get('target'));
                } else {
                    performFullSync();
                }
            } catch(e) { window.location.href = 'index.html'; }
        }

        async function performFullSync() {
            try {
                // Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ (Ù†Ø³Ø®Ù‡ Ø§Ù…Ù†: Ø¨Ø¯ÙˆÙ† Ø¬ÙˆØ§Ø¨)
                const resExams = await fetch(`${API_URL}?t=${Date.now()}`, { method: 'POST', headers: { "Content-Type": "application/json" }, body: JSON.stringify({ action: 'get_exams' }) });
                const examData = await resExams.json();

                if(examData.status === 'success') {
                    processExams(examData.data || []);
                    checkActiveSession();
                    
                    fetch(API_URL, { method: 'POST', headers: { "Content-Type": "application/json" }, body: JSON.stringify({ action: 'login', username: currentUser.username, password: currentUser.password }) })
                    .then(r=>r.json()).then(d=>{
                         if(d.status==='success') {
                             RankSystem.init(d.jsonData);
                             updateLocalCreds(d.jsonData);
                             processExams(examData.data || []); 
                         }
                    });
                }
            } catch(e) { document.getElementById('loading').innerHTML = `<span style="color:red">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„</span>`; }
        }

        function updateLocalCreds(jsonData) {
            if(currentUser) {
                currentUser.jsonData = jsonData;
                localStorage.setItem('chamran_db_vfinal_creds', JSON.stringify(currentUser));
            }
        }

        function processExams(list) {
            examsMap = {};
            const container = document.getElementById('examList');
            container.innerHTML = '';
            document.getElementById('loading').style.display = 'none';

            if(list.length === 0) { container.innerHTML = "<p>Ø¢Ø²Ù…ÙˆÙ†ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>"; return; }

            list.reverse().forEach(ex => {
                examsMap[ex.id] = ex;
                const sId = String(ex.id);
                const userExams = RankSystem.data.exams || {};
                const score = userExams[sId]; 
                const isTaken = (score !== undefined);

                const div = document.createElement('div');
                div.className = `exam-item ${isTaken ? 'locked' : ''}`;
                
                if(isTaken) {
                    let quality = "";
                    if(score >= 20) quality = "ğŸ’ ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡";
                    else if(score >= 17) quality = "ğŸ¥‡ Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨";
                    else if(score >= 12) quality = "ğŸ™‚ Ø®ÙˆØ¨";
                    else if(score >= 8) quality = "âš ï¸ Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„";
                    else quality = "â›” Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙ„Ø§Ø´";

                    const color = score >= 15 ? '#27ae60' : (score < 10 ? '#c0392b' : '#f39c12');
                    
                    div.innerHTML = `
                        <div style="text-align:right">
                            <h4>${ex.title}</h4>
                            <small>Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</small>
                        </div>
                        <div style="text-align:left">
                            <span style="font-weight:bold; color:${color}; font-size:0.9rem;">${quality}</span><br>
                            <button onclick="goToReview('${sId}')" style="background:none; border:none; color:#2980b9; cursor:pointer; font-size:0.8rem; padding:0; margin-top:5px;">ğŸ” Ù…Ø±ÙˆØ± Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§</button>
                        </div>`;
                } else {
                    const newBadge = ex.is_new ? '<div class="new-badge">Ø¬Ø¯ÛŒØ¯ ğŸ”¥</div>' : '';
                    div.innerHTML = `
                        ${newBadge}
                        <div><h4>${ex.title}</h4><small>${ex.time} Ø¯Ù‚ÛŒÙ‚Ù‡</small></div>
                        <button class="btn-start" style="padding:5px 15px; border-radius:8px; border:none; cursor:pointer;" onclick="showIntro('${ex.id}')">Ø´Ø±ÙˆØ¹</button>`;
                }
                container.appendChild(div);
            });
        }

        // --- Ù…Ù†Ø·Ù‚ Ø±Ø§Ù‡Ù†Ù…Ø§ (Intro) ---
        function showIntro(id) {
            const ex = examsMap[id];
            if(!ex) return;
            if(ex.pass && ex.pass !== '***' && prompt("Ø±Ù…Ø²:") !== ex.pass) return alert("Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡");
            
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('introCard').style.display = 'block';
            
            document.getElementById('introTitle').innerText = ex.title;
            document.getElementById('introQCount').innerText = toPersianNum(ex.questions.length);
            document.getElementById('introTime').innerText = toPersianNum(ex.time);
            
            const r = ex.rewards || { excellent: 300, good: 100, normal: 20 };
            document.getElementById('rewEx').innerText = `${r.excellent} XP`;
            document.getElementById('rewVg').innerText = `${r.good} XP`;
            document.getElementById('rewNr').innerText = `${r.normal} XP`;
            
            currentExamId = id;
        }

        function startExamNow() { startExam(currentExamId); }

        function startExam(id) {
            const ex = examsMap[id];
            currentExamId = id;
            currentQuestions = ex.questions;
            userAnswers = {};
            currentQIndex = 0;
            localStorage.setItem(EXAM_STATE_KEY, JSON.stringify({ id, start: Date.now(), end: Date.now() + ex.time*60000 }));
            showExamUI(ex.time * 60);
            SyncManager.addToQueue('report', { lesson: `Ø¢Ø²Ù…ÙˆÙ†: ${ex.title}`, status: 'Ø´Ø±ÙˆØ¹' });
        }
        
        function checkActiveSession() {
            const saved = localStorage.getItem(EXAM_STATE_KEY);
            if(saved) {
                const sess = JSON.parse(saved);
                if(examsMap[sess.id]) {
                    const remaining = Math.floor((sess.end - Date.now())/1000);
                    if(remaining > 0) {
                        if(confirm("ÛŒÚ© Ø¢Ø²Ù…ÙˆÙ† Ù†Ø§ØªÙ…Ø§Ù… Ø¯Ø§Ø±ÛŒØ¯. Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒØ¯ØŸ")) {
                            currentExamId = sess.id;
                            const ex = examsMap[sess.id];
                            currentQuestions = ex.questions;
                            userAnswers = {}; 
                            currentQIndex = 0;
                            showExamUI(remaining);
                        } else { localStorage.removeItem(EXAM_STATE_KEY); }
                    } else { localStorage.removeItem(EXAM_STATE_KEY); }
                }
            }
        }

        function showExamUI(time) {
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('introCard').style.display = 'none';
            document.getElementById('examArea').style.display = 'block';
            let t = time;
            timerInterval = setInterval(() => {
                t--;
                const m = Math.floor(t/60), s = t%60;
                document.getElementById('timer').innerText = `${m}:${s<10?'0'+s:s}`;
                if(t<=0) { clearInterval(timerInterval); alert("Ø²Ù…Ø§Ù† ØªÙ…Ø§Ù… Ø´Ø¯!"); finishExam(true); }
            }, 1000);
            loadQuestion();
        }

        function loadQuestion() {
            const q = currentQuestions[currentQIndex];
            document.getElementById('qProgress').innerText = `Ø³ÙˆØ§Ù„ ${currentQIndex+1} Ø§Ø² ${currentQuestions.length}`;
            document.getElementById('questionText').innerText = q.q;
            
            const imgEl = document.getElementById('questionImage');
            if(q.img) { imgEl.src = q.img; imgEl.style.display = 'block'; } else imgEl.style.display = 'none';
            
            const cont = document.getElementById('optionsContainer');
            cont.innerHTML = '';
            q.options.forEach((opt, i) => {
                const val = i+1;
                const div = document.createElement('div');
                div.className = `option ${userAnswers[currentQIndex]==val ? 'selected' : ''}`;
                
                let content = opt;
                if(opt.startsWith('http') || opt.startsWith('/uploads')) content = `<img src="${opt}" onclick="event.stopPropagation(); openLightbox(this.src)">`;
                
                div.innerHTML = `<b>${val})</b> ${content}`;
                div.onclick = () => { userAnswers[currentQIndex] = val; loadQuestion(); }; 
                cont.appendChild(div);
            });

            document.getElementById('btnNext').style.display = currentQIndex < currentQuestions.length-1 ? 'block' : 'none';
            document.getElementById('btnFinish').style.display = currentQIndex === currentQuestions.length-1 ? 'block' : 'none';
        }

        function nextQuestion() { currentQIndex++; loadQuestion(); }

        // --- Ø¨Ø®Ø´ Ù…Ù‡Ù…: ØªØµØ­ÛŒØ­ Ø³Ù…Øª Ø³Ø±ÙˆØ± ---
        async function finishExam(forced = false) {
            clearInterval(timerInterval);
            localStorage.removeItem(EXAM_STATE_KEY);
            
            // Ù†Ù…Ø§ÛŒØ´ Ù„ÙˆØ¯ÛŒÙ†Ú¯ ØªÙ…Ø§Ù… ØµÙØ­Ù‡
            document.getElementById('fullLoading').style.display = 'flex';

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        action: 'submit_exam',
                        username: currentUser.username,
                        password: currentUser.password,
                        exam_id: currentExamId,
                        user_answers: userAnswers
                    })
                });
                
                const data = await res.json();
                
                if(data.status === 'success') {
                    // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯ÛŒØªØ§ÛŒ Ù…Ø­Ù„ÛŒ Ø¨Ø§ Ø¯ÛŒØªØ§ÛŒ ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡ Ø³Ø±ÙˆØ±
                    RankSystem.init(data.serverData);
                    updateLocalCreds(data.serverData);
                    
                    showReportCard(data.score, data.xpAdded);
                } else {
                    alert("Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø¢Ø²Ù…ÙˆÙ†: " + data.message);
                    window.location.reload();
                }
            } catch(e) {
                alert("Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡! Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¯Ú©Ù…Ù‡ Ø«Ø¨Øª Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.");
            } finally {
                document.getElementById('fullLoading').style.display = 'none';
            }
        }

        function showReportCard(score, xpAdded) {
            document.getElementById('examArea').style.display = 'none';
            document.getElementById('reportCard').style.display = 'block';

            document.getElementById('finalScoreDisplay').innerText = score;
            document.getElementById('xpGainedDisplay').innerText = xpAdded > 0 ? `+${xpAdded}` : '0';

            setTimeout(() => { document.getElementById('scorePointer').style.left = ((score/20)*100) + '%'; }, 200);

            let qText = "Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙ„Ø§Ø´"; 
            let color = "#c0392b";
            const numScore = parseFloat(score);

            if(numScore >= 20) { qText = "ğŸ’ ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡"; color="#8e44ad"; if(typeof launchConfetti === 'function') launchConfetti(); }
            else if(numScore >= 17) { qText = "ğŸ¥‡ Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨"; color="#2ecc71"; if(typeof launchConfetti === 'function') launchConfetti(); }
            else if(numScore >= 12) { qText = "ğŸ™‚ Ø®ÙˆØ¨"; color="#2980b9"; }
            else if(numScore >= 8) { qText = "âš ï¸ Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„"; color="#f1c40f"; }
            
            const qEl = document.getElementById('qualitativeScore');
            qEl.innerText = qText; 
            qEl.style.color = color;
            
            document.getElementById('btnReview').style.display = 'block';
            document.getElementById('xpMsg').style.display = 'block';
        }

        function startReviewMode() {
            document.getElementById('reportCard').style.display = 'none';
            document.getElementById('reviewArea').style.display = 'block';
            renderReview(currentQuestions, userAnswers);
        }

        function goToReview(id) {
            window.location.href = `azmoon.html?mode=history_review&target=${id}`;
        }

        async function prepareReviewMode(targetId) {
            if(!targetId) return;
            document.getElementById('loading').innerText = "Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù¾Ø§Ø³Ø®â€ŒØ¨Ø±Ú¯...";
            document.getElementById('loading').style.display = 'block';

            const sTargetId = String(targetId);
            let myData = (RankSystem.data.exam_details || {})[sTargetId];
            
            // Ø§Ú¯Ø± Ø¯ÛŒØªØ§ Ù†Ø¨ÙˆØ¯ØŒ Ø³Ø¹ÛŒ Ú©Ù† Ø§Ø² Ø³Ø±ÙˆØ± Ø¨Ú¯ÛŒØ±ÛŒ
            if(!myData) {
                await performFullSync(); 
                myData = (RankSystem.data.exam_details || {})[sTargetId];
            }

            // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø³ÙˆØ§Ù„Ø§Øª Ø¢Ø²Ù…ÙˆÙ†
            let examList = [];
            try {
                const resEx = await fetch(`${API_URL}?t=${Date.now()}`, { method: 'POST', headers: { "Content-Type": "application/json" }, body: JSON.stringify({ action: 'get_exams' }) });
                const eData = await resEx.json();
                examList = eData.data || [];
            } catch(e) {}

            const exam = examList.find(e => String(e.id) === sTargetId);

            if(exam && myData) {
                document.getElementById('lobby').style.display = 'none';
                document.getElementById('reviewArea').style.display = 'block';
                renderReview(exam.questions, myData.answers || {});
            } else { 
                alert("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¢Ø²Ù…ÙˆÙ† ÛŒØ§ÙØª Ù†Ø´Ø¯."); 
                window.location.href = 'azmoon.html'; 
            }
        }

        function renderReview(questions, answers) {
            const c = document.getElementById('reviewContent');
            c.innerHTML = '';
            questions.forEach((q, i) => {
                const uAns = answers[i];
                let html = `<div class="review-q"><b>Ø³ÙˆØ§Ù„ ${i+1}:</b> ${q.q}`;
                if(q.img) html += `<br><img src="${q.img}" onclick="openLightbox(this.src)">`;
                
                q.options.forEach((op, idx) => {
                    const val = idx+1;
                    let color = "#fff", border = "#eee";
                    
                    // Ú†ÙˆÙ† Ø¬ÙˆØ§Ø¨ ØµØ­ÛŒØ­ (q.correct) Ø§Ø² Ø³Ù…Øª Ø³Ø±ÙˆØ± Ù†Ù…ÛŒ Ø¢ÛŒØ¯ØŒ ÙÙ‚Ø· Ø¬ÙˆØ§Ø¨ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒØ¯Ù‡ÛŒÙ…
                    // Ø¨Ø±Ø§ÛŒ Ø§Ù…Ù†ÛŒØª Ø¨ÛŒØ´ØªØ±ØŒ Ø§Ú¯Ø± Ù…ÛŒØ®ÙˆØ§Ù‡ÛŒ Ø¬ÙˆØ§Ø¨ Ø¯Ø±Ø³Øª Ø±Ø§ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡ÛŒØŒ Ø¨Ø§ÛŒØ¯ Ø¨Ø¹Ø¯ Ø§Ø² Ø§ØªÙ…Ø§Ù… Ø¢Ø²Ù…ÙˆÙ†ØŒ Ø³Ø±ÙˆØ± Ú©Ù„ÛŒØ¯ Ø±Ø§ Ø¨ÙØ±Ø³ØªØ¯
                    // ÙØ¹Ù„Ø§ ÙÙ‚Ø· Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒØ¯Ù‡ÛŒÙ… (Ø¢Ø¨ÛŒ)
                    if(val == uAns) { color = "#e3f2fd"; border = "#2196f3"; } 
                    
                    let content = optIsImage(op) ? `<img src="${op}" style="max-height:100px; vertical-align:middle">` : op;
                    html += `<div style="background:${color}; border:1px solid ${border}; padding:10px; margin:5px 0; border-radius:10px;">${val}) ${content}</div>`;
                });
                
                if(q.desc || q.desc_img) {
                    html += `<div style="background:#fff3cd; padding:10px; margin-top:10px; border-radius:8px; font-size:0.9rem;">ğŸ’¡ <b>ØªÙˆØ¶ÛŒØ­:</b> ${q.desc || ''}`;
                    if(q.desc_img) html += `<br><img src="${q.desc_img}" onclick="openLightbox(this.src)" style="max-width:100%; border-radius:8px; margin-top:5px;">`;
                    html += `</div>`;
                }
                
                html += `</div>`;
                c.innerHTML += html;
            });
        }

        function optIsImage(s) { return s.startsWith('http') || s.startsWith('/uploads'); }
        function openLightbox(src) { document.getElementById('lightboxImg').src = src; document.getElementById('lightbox').style.display = 'flex'; }
        
        function toPersianNum(n) { return n.toString().replace(/\d/g, x => ['Û°','Û±','Û²','Û³','Û´','Ûµ','Û¶','Û·','Û¸','Û¹'][x]); }

        window.onload = init;
    </script>
</body>
</html>
