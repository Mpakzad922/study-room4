<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¯ÙØªØ± Ù…Ø´Ù‚ Ù…Ù† ğŸ“</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />
    <style>
        :root { --primary: #2c3e50; --accent: #e67e22; --bg: #ecf0f1; --success: #27ae60; --danger: #c0392b; --info: #3498db; --wait: #f39c12; }
        body { font-family: 'Vazirmatn', sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; user-select: none; -webkit-tap-highlight-color: transparent; }

        /* Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ */
        .card { background: white; width: 100%; max-width: 500px; padding: 20px; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); margin-bottom: 15px; transition: 0.2s; position: relative; overflow: hidden; }
        .card:active { transform: scale(0.98); }
        
        .header-card { text-align: center; background: linear-gradient(135deg, #2c3e50, #34495e); color: white; }
        .back-btn { position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.2); border: none; color: white; width: 35px; height: 35px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .back-btn:hover { background: rgba(255,255,255,0.4); }

        /* Ù„ÛŒØ³Øª ØªÚ©Ø§Ù„ÛŒÙ */
        #hwList { width: 100%; max-width: 500px; padding-bottom: 50px; }
        .hw-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 2px solid #eee; border-radius: 15px; margin-bottom: 10px; cursor: pointer; background: white; transition: 0.2s; position: relative; }
        .hw-item:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .hw-item.done { border-color: var(--success); background: #f0fdf4; }
        .hw-item.pending { border-color: var(--wait); background: #fdf5e6; }
        .hw-item.new { border-color: var(--danger); }
        
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; color: white; font-weight: bold; }
        .b-new { background: var(--danger); animation: pulse 1.5s infinite; }
        .b-done { background: var(--success); }
        .b-wait { background: var(--wait); }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* ØµÙØ­Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª (Ù…ÙˆØ¯Ø§Ù„) */
        #detailPage { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 1000; display: none; flex-direction: column; overflow-y: auto; padding: 20px; box-sizing: border-box; align-items: center; }
        .detail-card { background: white; width: 100%; max-width: 500px; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }

        .desc-box { background: #fff8e1; border: 1px dashed #f1c40f; padding: 15px; border-radius: 12px; margin-bottom: 20px; line-height: 1.6; font-size: 0.95rem; width: 100%; box-sizing: border-box; color: #5d4037; }

        /* Ø¨Ø®Ø´ Ø¶Ø¨Ø· ØµØ¯Ø§ */
        .recorder-box { text-align: center; padding: 20px; border: 2px dashed #bdc3c7; border-radius: 20px; background: #f9f9f9; margin-bottom: 20px; width: 100%; box-sizing: border-box; }
        .mic-btn { width: 80px; height: 80px; border-radius: 50%; border: none; background: var(--danger); color: white; font-size: 2rem; cursor: pointer; box-shadow: 0 5px 15px rgba(192, 57, 43, 0.4); transition: 0.3s; display: flex; align-items: center; justify-content: center; margin: 0 auto; }
        .mic-btn.recording { animation: ripple 1s infinite; background: #e74c3c; }
        @keyframes ripple { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 100% { box-shadow: 0 0 0 20px rgba(231, 76, 60, 0); } }
        
        .timer { font-size: 1.5rem; font-weight: bold; margin-top: 10px; color: var(--primary); font-family: monospace; }
        .preview-box { display: none; margin-top: 15px; }
        .audio-player { width: 100%; margin-top: 10px; height: 45px; border-radius: 25px; background: #f1f3f4; }

        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
        .action-btn { width: 100%; padding: 15px; border: none; border-radius: 15px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; color: white; }
        .action-btn:active { transform: scale(0.98); }
        .btn-send { background: var(--success); box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3); }
        .btn-photo { background: var(--info); box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3); }
        .btn-cancel { background: #95a5a6; }

        /* ÙÛŒØ¯Ø¨Ú© Ù…Ø¹Ù„Ù… (Ø¬Ø¯ÛŒØ¯) */
        .feedback-box { background: white; border: 2px solid var(--success); padding: 20px; border-radius: 15px; margin-top: 20px; display: none; width: 100%; box-sizing: border-box; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .grade-badge { display: inline-block; padding: 8px 20px; border-radius: 20px; background: var(--success); color: white; font-weight: bold; font-size: 1.2rem; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3); }
        
        /* ğŸ†• Ø§Ø³ØªØ§ÛŒÙ„ Ù†Ù…Ø§ÛŒØ´ ÙØ§ÛŒÙ„ Ø§Ø±Ø³Ø§Ù„ÛŒ Ø®ÙˆØ¯ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² */
        .my-submission-view { background: #f0f3f5; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #dfe6e9; }
        .sub-label { font-size: 0.85rem; color: #7f8c8d; margin-bottom: 8px; display: block; font-weight: bold; }

        /* Ù„Ø§ÛŒØª Ø¨Ø§Ú©Ø³ (Ø²ÙˆÙ… Ø¹Ú©Ø³) */
        #lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; cursor: zoom-out; backdrop-filter: blur(5px); }
        #lightbox img { max-width: 95%; max-height: 95%; border-radius: 5px; box-shadow: 0 0 30px rgba(255,255,255,0.2); animation: zoomIn 0.3s; object-fit: contain; }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .thumb-img { width: 100%; max-height: 200px; object-fit: cover; border-radius: 10px; border: 2px solid #eee; cursor: zoom-in; margin-top: 10px; display: block; }

        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 2000; display: flex; justify-content: center; align-items: center; flex-direction: column; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

    <div id="loading">
        <div style="font-size:2rem; margin-bottom:10px;">â³</div>
        Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...
    </div>

    <div id="lightbox" onclick="this.style.display='none'">
        <img id="lightboxImg" src="">
    </div>

    <div class="card header-card">
        <button class="back-btn" onclick="window.location.href='index.html'">â†©ï¸</button>
        <h2 style="margin:0;">Ø¯ÙØªØ± Ù…Ø´Ù‚ ğŸ“</h2>
        <p style="font-size:0.9rem; opacity:0.9; margin-top:5px;">ØªÚ©Ø§Ù„ÛŒÙ Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø¨ÛŒÙ†ÛŒØ¯ Ùˆ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯</p>
    </div>

    <div id="hwListContainer" style="width: 100%; max-width: 500px;"></div>

    <div id="detailPage">
        <div class="card header-card" style="margin-bottom:20px; border-radius:0 0 20px 20px; width:100%; max-width:500px; padding:15px;">
            <button class="back-btn" onclick="closeDetail()">âœ–ï¸</button>
            <h3 id="dTitle" style="margin:0;">Ø¹Ù†ÙˆØ§Ù† ØªÚ©Ù„ÛŒÙ</h3>
        </div>

        <div style="width:100%; max-width:500px;">
            <div class="desc-box">
                <b>ğŸ“Œ ØªÙˆØ¶ÛŒØ­Ø§Øª Ù…Ø¹Ù„Ù…:</b><br>
                <span id="dDesc">...</span>
            </div>

            <div id="myWorkContainer" class="my-submission-view" style="display:none;">
                <span class="sub-label">ğŸ“¤ ÙØ§ÛŒÙ„ Ø§Ø±Ø³Ø§Ù„ÛŒ Ø´Ù…Ø§:</span>
                <div id="myWorkContent"></div>
            </div>

            <div id="feedbackContainer" class="feedback-box">
                <div style="text-align:center;">
                    <div id="fGrade" class="grade-badge">Ø¹Ø§Ù„ÛŒ</div>
                </div>
                
                <div style="background:#f9f9f9; padding:12px; border-radius:10px; border-right:4px solid var(--info); margin-bottom:15px;">
                    <b>âœï¸ Ù¾ÛŒØ§Ù… Ù…Ø¹Ù„Ù…:</b><br>
                    <span id="fText" style="color:#555;">...</span>
                </div>

                <div id="fVoiceBox" style="display:none; margin-top:15px; background:#f1f2f6; padding:10px; border-radius:10px;">
                    <div style="font-size:0.9rem; margin-bottom:5px; font-weight:bold; color:var(--primary);">ğŸ”Š ØµØ¯Ø§ÛŒ Ù…Ø¹Ù„Ù…:</div>
                    <audio id="fAudio" controls class="audio-player"></audio>
                </div>

                <div id="fImageBox" style="display:none; margin-top:15px;">
                    <div style="font-size:0.9rem; margin-bottom:5px; font-weight:bold; color:var(--primary);">ğŸ–¼ï¸ ØªØµÙˆÛŒØ± Ù…Ø¹Ù„Ù…:</div>
                    <img id="fImage" class="thumb-img" onclick="openLightbox(this.src)">
                </div>
            </div>

            <div id="submissionArea">
                <div class="recorder-box">
                    <div id="recStatus" style="margin-bottom:15px; color:#7f8c8d;">Ø¨Ø±Ø§ÛŒ Ø¶Ø¨Ø· ØµØ¯Ø§ Ø¯Ú©Ù…Ù‡ Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯</div>
                    <button id="micBtn" class="mic-btn">ğŸ™ï¸</button>
                    <div id="timerDisplay" class="timer">00:00</div>
                    <div id="audioPreview" class="preview-box">
                        <audio id="audioPlayer" controls class="audio-player"></audio>
                        <button onclick="resetRecorder()" style="background:none; border:none; color:var(--danger); cursor:pointer; margin-top:10px; font-size:0.9rem;">ğŸ—‘ï¸ Ø­Ø°Ù Ùˆ Ø¶Ø¨Ø· Ù…Ø¬Ø¯Ø¯</button>
                        <button onclick="uploadVoice()" class="action-btn btn-send">ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ ÙˆÛŒØ³</button>
                    </div>
                </div>
                <div style="text-align:center; color:#aaa; margin:10px 0;">--- ÛŒØ§ ---</div>
                <button onclick="document.getElementById('imgInput').click()" class="action-btn btn-photo">ğŸ“· Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ Ø§Ø² Ú¯Ø§Ù„Ø±ÛŒ</button>
                <input type="file" id="imgInput" accept="image/*" style="display:none" onchange="handleImage(this)">
                <div id="imgPreviewBox" style="display:none; margin-top:15px; text-align:center;">
                    <img id="imgPreview" class="thumb-img" onclick="openLightbox(this.src)">
                    <button onclick="uploadImage()" class="action-btn btn-send" style="margin-top:10px;">ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³</button>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        const API_URL = APP_CONFIG.API_URL;
        let currentHwId = null;
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob = null;
        let timerInterval;
        let selectedImageFile = null;
        let isRecording = false;

        window.addEventListener('load', () => { fetchHomeworks(); });

        async function fetchHomeworks() {
            const saved = localStorage.getItem('chamran_db_vfinal_creds');
            if(!saved) { window.location.href = 'index.html'; return; }
            const user = JSON.parse(saved);

            try {
                const res = await fetch(API_URL, { method: 'POST', headers: { "Content-Type": "application/json" }, body: JSON.stringify({ action: 'get_homeworks', username: user.username }) });
                const data = await res.json();
                if(data.status === 'success') renderList(data.data);
                else document.getElementById('hwListContainer').innerHTML = '<p style="text-align:center">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª</p>';
            } catch(e) {}
            document.getElementById('loading').style.display = 'none';
        }

        function renderList(list) {
            const container = document.getElementById('hwListContainer'); container.innerHTML = '';
            if(list.length === 0) { container.innerHTML = '<div class="card" style="text-align:center; color:#999;">ğŸ“­ ÙØ¹Ù„Ø§Ù‹ Ù…Ø´Ù‚ÛŒ Ù†Ø¯Ø§Ø±ÛŒ!</div>'; return; }
            
            list.sort((a,b) => {
                const sA = a.my_status?(a.my_status.status==='graded'?2:1):0;
                const sB = b.my_status?(b.my_status.status==='graded'?2:1):0;
                return sA - sB; 
            });

            list.forEach(hw => {
                let statusClass = '', badgeHtml = '', statusText = 'Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡';
                if(hw.my_status) {
                    if(hw.my_status.status === 'graded') {
                        statusClass = 'done'; badgeHtml = `<span class="badge b-done">${hw.my_status.grade || 'Ù†Ù…Ø±Ù‡ Ø«Ø¨Øª Ø´Ø¯'}</span>`; statusText = 'Ù†Ù…Ø±Ù‡ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯ âœ…';
                    } else {
                        statusClass = 'pending'; badgeHtml = '<span class="badge b-wait">Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡</span>'; statusText = 'Ù…Ù†ØªØ¸Ø± Ø¨Ø±Ø±Ø³ÛŒ â³';
                    }
                } else { statusClass = 'new'; badgeHtml = '<span class="badge b-new">Ø¬Ø¯ÛŒØ¯</span>'; }

                const div = document.createElement('div');
                div.className = `hw-item ${statusClass}`;
                div.onclick = () => openDetail(hw);
                div.innerHTML = `<div><div style="font-weight:bold; font-size:1rem; margin-bottom:5px;">${hw.title}</div><div style="font-size:0.8rem; color:#7f8c8d;">ğŸ“… ${hw.date}</div></div><div style="text-align:left;">${badgeHtml}<div style="font-size:0.7rem; margin-top:5px; color:#95a5a6;">${statusText}</div></div>`;
                container.appendChild(div);
            });
        }

        // --- Ø³Ø§Ø®Øª Ù„ÛŒÙ†Ú© Ø³Ø§Ù„Ù… (Ù…Ù‡Ù… Ø¨Ø±Ø§ÛŒ Ø­Ù„ Ù…Ø´Ú©Ù„ ÙˆÛŒØ³) ---
        function getSafeUrl(path) {
            if(!path) return '';
            if(path.startsWith('http')) return path;
            // Ø­Ø°Ù Ø§Ø³Ù„Ø´ Ø§Ø¶Ø§ÙÛŒ Ø§Ø² Ø¢Ø®Ø± API_URL Ùˆ Ø§ÙˆÙ„ path
            let base = API_URL.replace(/\/$/, '');
            let rel = path.startsWith('/') ? path : '/' + path;
            return base + rel;
        }

        function openDetail(hw) {
            currentHwId = hw.id;
            document.getElementById('detailPage').style.display = 'flex';
            document.getElementById('dTitle').innerText = hw.title;
            document.getElementById('dDesc').innerText = hw.desc || "ØªÙˆØ¶ÛŒØ­Ø§ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.";

            const subArea = document.getElementById('submissionArea');
            const fbContainer = document.getElementById('feedbackContainer');
            const myWorkContainer = document.getElementById('myWorkContainer');

            resetRecorder();
            document.getElementById('imgPreviewBox').style.display = 'none';
            selectedImageFile = null;

            if(hw.my_status && hw.my_status.status === 'graded') {
                subArea.style.display = 'none';
                fbContainer.style.display = 'block';
                
                // Ù†Ù…Ø§ÛŒØ´ ÙØ§ÛŒÙ„ Ø§Ø±Ø³Ø§Ù„ÛŒ Ø®ÙˆØ¯ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
                myWorkContainer.style.display = 'block';
                const myContent = document.getElementById('myWorkContent');
                let myFileUrl = getSafeUrl(hw.my_status.file);
                if(hw.my_status.type === 'voice') myContent.innerHTML = `<audio controls src="${myFileUrl}" class="audio-player"></audio>`;
                else myContent.innerHTML = `<img src="${myFileUrl}" class="thumb-img" onclick="openLightbox(this.src)">`;

                document.getElementById('fGrade').innerText = hw.my_status.grade;
                document.getElementById('fText').innerText = hw.my_status.feedback || "Ø¨Ø¯ÙˆÙ† Ù¾ÛŒØ§Ù….";
                
                // ÙˆÛŒØ³ Ù…Ø¹Ù„Ù… (Ø¨Ø§ Ù„ÛŒÙ†Ú© Ø³Ø§Ù„Ù…)
                if(hw.my_status.teacher_voice) {
                    document.getElementById('fVoiceBox').style.display = 'block';
                    const audioEl = document.getElementById('fAudio');
                    audioEl.src = getSafeUrl(hw.my_status.teacher_voice);
                    audioEl.load();
                } else document.getElementById('fVoiceBox').style.display = 'none';

                // Ø¹Ú©Ø³ Ù…Ø¹Ù„Ù…
                if(hw.my_status.teacher_image) {
                    document.getElementById('fImageBox').style.display = 'block';
                    document.getElementById('fImage').src = getSafeUrl(hw.my_status.teacher_image);
                } else document.getElementById('fImageBox').style.display = 'none';

            } else {
                subArea.style.display = 'block';
                fbContainer.style.display = 'none';
                myWorkContainer.style.display = 'none';
                if (hw.my_status && hw.my_status.status === 'pending') document.getElementById('recStatus').innerText = "âœ… Ù‚Ø¨Ù„Ø§Ù‹ ÙØ§ÛŒÙ„ Ø§Ø±Ø³Ø§Ù„ Ú©Ø±Ø¯ÛŒØ¯ (Ø§Ø±Ø³Ø§Ù„ Ù…Ø¬Ø¯Ø¯ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…ÛŒâ€ŒØ´ÙˆØ¯)";
                else document.getElementById('recStatus').innerText = "Ø¨Ø±Ø§ÛŒ Ø¶Ø¨Ø· ØµØ¯Ø§ Ø¯Ú©Ù…Ù‡ Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯";
            }
        }

        function closeDetail() {
            document.getElementById('detailPage').style.display = 'none';
            if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
            if(document.getElementById('fAudio')) document.getElementById('fAudio').pause();
        }

        function openLightbox(src) {
            document.getElementById('lightboxImg').src = src;
            document.getElementById('lightbox').style.display = 'flex';
        }

        // --- Ø¶Ø¨Ø· ØµØ¯Ø§ ---
        const micBtn = document.getElementById('micBtn');
        const timerDisplay = document.getElementById('timerDisplay');
        let startTime;

        micBtn.addEventListener('click', async () => {
            if (!isRecording) startRecording(); else stopRecording();
        });

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    document.getElementById('audioPlayer').src = URL.createObjectURL(audioBlob);
                    document.getElementById('micBtn').style.display = 'none';
                    document.getElementById('timerDisplay').style.display = 'none';
                    document.getElementById('audioPreview').style.display = 'block';
                    clearInterval(timerInterval);
                    isRecording = false;
                };
                mediaRecorder.start();
                isRecording = true;
                micBtn.classList.add('recording');
                document.getElementById('recStatus').innerText = "Ø¯Ø±Ø­Ø§Ù„ Ø¶Ø¨Ø·... (Ø¨Ø±Ø§ÛŒ ØªÙˆÙ‚Ù Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯)";
                startTime = Date.now();
                timerInterval = setInterval(() => {
                    const diff = Math.floor((Date.now() - startTime) / 1000);
                    const m = Math.floor(diff / 60);
                    const s = diff % 60;
                    timerDisplay.innerText = `${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
                }, 1000);
            } catch (err) { alert("Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯!"); }
        }

        function stopRecording() { if(mediaRecorder) mediaRecorder.stop(); micBtn.classList.remove('recording'); }

        function resetRecorder() {
            audioBlob = null; audioChunks = []; isRecording = false;
            document.getElementById('micBtn').style.display = 'flex';
            document.getElementById('micBtn').classList.remove('recording');
            document.getElementById('timerDisplay').style.display = 'block';
            document.getElementById('timerDisplay').innerText = "00:00";
            document.getElementById('audioPreview').style.display = 'none';
            document.getElementById('recStatus').innerText = "Ø¨Ø±Ø§ÛŒ Ø¶Ø¨Ø· ØµØ¯Ø§ Ø¯Ú©Ù…Ù‡ Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯";
            if(timerInterval) clearInterval(timerInterval);
        }

        function handleImage(input) {
            if (input.files && input.files[0]) {
                selectedImageFile = input.files[0];
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('imgPreview').src = e.target.result;
                    document.getElementById('imgPreviewBox').style.display = 'block';
                };
                reader.readAsDataURL(selectedImageFile);
            }
        }

        async function uploadVoice() {
            if(!audioBlob) return;
            const reader = new FileReader(); reader.readAsDataURL(audioBlob);
            reader.onloadend = () => performSubmit(reader.result, 'voice.webm', 'voice');
        }

        async function uploadImage() {
            if(!selectedImageFile) return;
            const reader = new FileReader(); reader.readAsDataURL(selectedImageFile);
            reader.onloadend = () => performSubmit(reader.result, selectedImageFile.name, 'image');
        }

        async function performSubmit(fileData, fileName, type) {
            document.getElementById('loading').style.display = 'flex';
            const user = JSON.parse(localStorage.getItem('chamran_db_vfinal_creds'));
            try {
                const upRes = await fetch(API_URL, { method: 'POST', headers: { "Content-Type": "application/json" }, body: JSON.stringify({ action: 'upload_file', file_data: fileData, file_name: fileName, hw_type: type, username: user.username }) });
                const upData = await upRes.json();
                if(upData.status === 'success') {
                    const subRes = await fetch(API_URL, { method: 'POST', headers: { "Content-Type": "application/json" }, body: JSON.stringify({ action: 'submit_homework', username: user.username, password: user.password, hw_id: currentHwId, link: upData.url, hw_type: type }) });
                    const subData = await subRes.json();
                    if(subData.status === 'success') { alert("âœ… Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!"); closeDetail(); fetchHomeworks(); } 
                    else { alert("Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª"); }
                } else { alert("Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯"); }
            } catch(e) { alert("Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡"); }
            document.getElementById('loading').style.display = 'none';
        }
    </script>
</body>
</html>
